"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("express")),o=e(require("http")),s=e(require("https")),r=require("itee-validators"),i=e(require("path"));exports.TBackendManager=
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 *
 * @file Todo
 *
 * @example Todo
 *
 */
class{constructor(e){this.rootPath=e.rootPath,this.applications=t(),this.router=t.Router,this.databases=new Map,this.servers=new Map,this._initApplications(e.applications),this._initDatabases(e.databases),this._initServers(e.servers)}get rootPath(){return this._rootPath}set rootPath(e){if(r.isNull(e))throw new TypeError("Root path cannot be null ! Expect a non empty string.");if(r.isUndefined(e))throw new TypeError("Root path cannot be undefined ! Expect a non empty string.");if(r.isNotString(e))throw new TypeError(`Root path cannot be an instance of ${e.constructor.name} ! Expect a non empty string.`);if(r.isEmptyString(e))throw new TypeError("Root path cannot be empty ! Expect a non empty string.");if(r.isBlankString(e))throw new TypeError("Root path cannot contain only whitespace ! Expect a non empty string.");this._rootPath=e}setRootPath(e){return this.rootPath=e,this}_initApplications(e){e.case_sensitive_routing&&this.applications.set("case sensitive routing",e.case_sensitive_routing),e.env&&this.applications.set("env",e.env),e.etag&&this.applications.set("etag",e.etag),e.jsonp_callback_name&&this.applications.set("jsonp callback name",e.jsonp_callback_name),e.jsonp_escape&&this.applications.set("json escape",e.jsonp_escape),e.jsonp_replacer&&this.applications.set("json replacer",e.jsonp_replacer),e.jsonp_spaces&&this.applications.set("json spaces",e.jsonp_spaces),e.query_parser&&this.applications.set("query parser",e.query_parser),e.strict_routing&&this.applications.set("strict routing",e.strict_routing),e.subdomain_offset&&this.applications.set("subdomain offset",e.subdomain_offset),e.trust_proxy&&this.applications.set("trust proxy",e.trust_proxy),e.views&&this.applications.set("views",e.views),e.view_cache&&this.applications.set("view cache",e.view_cache),e.view_engine&&this.applications.set("view engine",e.view_engine),e.x_powered_by&&this.applications.set("x-powered-by",e.x_powered_by),this._initMiddlewares(e.middlewares),this._initRouters(e.routers)}_initMiddlewares(e){for(let[t,o]of Object.entries(e)){if(r.isNotArray(o))throw new TypeError(`Invalid middlware configuration for ${t}, expecting an array of arguments to spread to middleware module, got ${o.constructor.name}`);this._initPackageMiddleware(t,o)?console.log(`Use ${t} middleware from node_modules`):this._initLocalMiddleware(t,o)?console.log(`Use ${t} middleware from local folder`):console.error(`Unable to register the middleware ${t} the package and/or local file doesn't seem to exist ! Skip it.`)}}_initPackageMiddleware(e,t){let o=!1;try{this.applications.use(require(e)(...t)),o=!0}catch(t){t.code&&"MODULE_NOT_FOUND"===t.code||(console.error(`The middleware "${e}" seems to encounter internal error.`),console.error(t))}return o}_initLocalMiddleware(e,t){let o=!1;try{const s=i.join(this.rootPath,"middlewares",e);this.applications.use(require(s)(...t)),o=!0}catch(e){console.error(e)}return o}_initRouters(e){for(let[t,o]of Object.entries(e))this._initPackageRouter(t,o)?console.log(`Use ${o} router from node_modules over base route: ${t}`):this._initLocalRouter(t,o)?console.log(`Use ${o} router from local folder over base route: ${t}`):console.error(`Unable to register the router ${o} the package and/or local file doesn't seem to exist ! Skip it.`)}_initPackageRouter(e,t){let o=!1;try{this.applications.use(e,require(t)),o=!0}catch(e){e.code&&"MODULE_NOT_FOUND"===e.code||(console.error(`The router "${name}" seems to encounter internal error.`),console.error(e))}return o}_initLocalRouter(e,t){let o=!1;try{const s=i.join(this.rootPath,"routers",t);this.applications.use(e,require(s)),o=!0}catch(e){e instanceof TypeError&&"Found non-callable @@iterator"===e.message&&console.error(`The router "${name}" seems to encounter error ! Are you using an object instead an array for router configuration ?`),console.error(e)}return o}_initDatabases(e){for(let t=0,o=e.length;t<o;t++){const o=e[t],s=o.type,i=o.from,n=`${o.name?o.name:`${s}_${t}`}`;try{let e=null;if(r.isDefined(i)){e=new(require(i)[s])({application:this.applications,router:this.router,...o})}e.connect(),this.databases.set(n,e)}catch(e){console.error(`Unable to create database of type ${s} due to ${e.name}`),console.error(e.message),console.error(e.stack)}}}_initServers(e){const t=r.isArray(e)?e:[e];for(let e=0,r=t.length;e<r;e++){let r=t[e],i=null;if("https"===r.type){const e={pfx:r.pfx,passphrase:r.passphrase};i=s.createServer(e,this.applications)}else i=o.createServer(this.applications);i.name=r.name||`${r.name?r.name:"Server_"+e}`,i.maxHeadersCount=r.max_headers_count,i.timeout=r.timeout,i.type=r.type,i.host=r.host,i.port=r.port,i.env=r.env,i.listen(r.port,r.host,()=>{console.log(`${i.name} start listening on ${i.type}://${i.host}:${i.port} at ${new Date} under ${i.env} environment.`)}),this.servers.set(i.name,i)}}databaseOn(e,t,o){}serverOn(e,t,o){this.servers[e].on(t,o)}serversOn(e,t,o){for(let e in this.servers)this.serverOn(e,t,o)}start(){}stop(e){const t=this.servers.size,o=this.databases.size;let s=0,r=0;if(0!==t||0!==o)for(const[i,n]of this.servers)n.close(()=>{if(s++,console.log(`The ${i} listening on ${n.type}://${n.host}:${n.port} is shutted down.`),!(s<t))if(0!==o)for(const[t,s]of this.databases)s.close(()=>{r++,console.log(`Connection to ${t} is closed.`),r<o||e&&e()});else e&&e()});else e&&e()}closeServers(){}};
//# sourceMappingURL=itee-server.cjs.min.js.map
